<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç–Ω—ã–π AI</title>
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s ease;
        }
        
        .container {
            background: white;
            max-width: 800px;
            width: 100%;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        h1 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ—Å–∫–∏ */
        .board-container {
            position: relative;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            padding-bottom: 100%; /* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω */
        }
        
        #board {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ—Å–∫–∏ */
        .board-b72b1 {
            background-color: #f0d9b5;
        }
        
        .square-55d63 {
            background-color: #b58863;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–æ—á–µ–∫ (–≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤) */
        .possible-move {
            position: absolute;
            width: 24%;
            height: 24%;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            margin: 38%;
            z-index: 2;
            pointer-events: none;
        }
        
        .square-55d63 .possible-move {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .theme-control {
            margin: 20px 0;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background: #2980b9;
        }
        
        /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã */
        #result {
            min-height: 60px;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            background: #f8f9fa;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
        body.dark {
            background: #121212;
            color: #e0e0e0;
        }
        
        body.dark .container {
            background: #1e1e1e;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        body.dark #result {
            background: #2a2a2a;
            color: #e0e0e0;
        }
        
        body.dark .board-b72b1 {
            background-color: #8d6e63;
        }
        
        body.dark .square-55d63 {
            background-color: #5d4037;
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .checkmate {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .draw {
            color: #f39c12;
            font-weight: bold;
        }
        
        .check {
            color: #3498db;
            font-weight: bold;
        }
        
        .error {
            color: #e74c3c;
        }
        
        .success {
            color: #2ecc71;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 500px) {
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
</head>
<body>
    <div class="container">
        <h1>‚ôüÔ∏è –®–∞—Ö–º–∞—Ç–Ω—ã–π AI</h1>
        
        <div class="theme-control">
            <button id="theme-btn">üåô –í–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É</button>
        </div>
        
        <div class="board-container">
            <div id="board"></div>
        </div>
        
        <div class="controls">
            <button id="analyze-btn">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
            <button id="reset-btn">–°–±—Ä–æ—Å–∏—Ç—å –¥–æ—Å–∫—É</button>
        </div>
        
        <div id="result"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js"></script>
    
    <script>
        // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
            const game = new Chess();
            let board;
            let selectedSquare = null;
            let possibleMoves = [];
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å–∫–∏
            function initBoard() {
                board = Chessboard('board', {
                    position: 'start',
                    draggable: true, // –û—Å—Ç–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                    onDrop: handleMove,
                    onDragStart: onDragStart
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–æ —Ç–æ—á–∫–∞–º
                $('#board').on('click', '.square-55d63', function() {
                    const square = $(this).data('square');
                    handleSquareClick(square);
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            function onDragStart(source, piece) {
                // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Ñ–∏–≥—É—Ä
                return (game.turn() === 'w' && piece.search(/^w/) !== -1) ||
                       (game.turn() === 'b' && piece.search(/^b/) !== -1);
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ñ–∏–≥—É—Ä—ã
            function handleMove(source, target) {
                const move = game.move({
                    from: source,
                    to: target,
                    promotion: 'q'
                });
                
                if (move === null) return 'snapback';
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ —Ö–æ–¥–∞
                clearPossibleMoves();
                updateStatus();
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∫–ª–µ—Ç–∫—É (–¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–æ —Ç–æ—á–∫–∞–º)
            function handleSquareClick(square) {
                // –ï—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞ —Ñ–∏–≥—É—Ä–∞
                if (selectedSquare) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–ª–∏–∫ –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã–π —Ö–æ–¥
                    const move = possibleMoves.find(m => m.to === square);
                    if (move) {
                        // –í—ã–ø–æ–ª–Ω—è–µ–º —Ö–æ–¥
                        game.move(move);
                        board.position(game.fen());
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ —Ö–æ–¥–∞
                        clearPossibleMoves();
                        updateStatus();
                    } else {
                        // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –Ω–∞ –≤–æ–∑–º–æ–∂–Ω—ã–π —Ö–æ–¥, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                        clearPossibleMoves();
                        
                        // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Å–≤–æ—é —Ñ–∏–≥—É—Ä—É, –≤—ã–±–∏—Ä–∞–µ–º –µ–µ
                        const piece = game.get(square);
                        if (piece && piece.color === game.turn()) {
                            selectPiece(square);
                        }
                    }
                } else {
                    // –ï—Å–ª–∏ —Ñ–∏–≥—É—Ä–∞ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –≤—ã–±–∏—Ä–∞–µ–º –µ–µ
                    const piece = game.get(square);
                    if (piece && piece.color === game.turn()) {
                        selectPiece(square);
                    }
                }
            }
            
            // –í—ã–±–æ—Ä —Ñ–∏–≥—É—Ä—ã –∏ –ø–æ–∫–∞–∑ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤
            function selectPiece(square) {
                selectedSquare = square;
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–æ–¥—ã –¥–ª—è —ç—Ç–æ–π —Ñ–∏–≥—É—Ä—ã
                possibleMoves = game.moves({
                    square: square,
                    verbose: true
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–∫–∏ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤
                showPossibleMoves(possibleMoves);
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤
            function showPossibleMoves(moves) {
                // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–æ—á–∫–∏
                clearPossibleMoves();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ç–æ—á–∫–∏
                moves.forEach(move => {
                    const $square = $(`#board .square-${move.to}`);
                    if ($square.length) {
                        $square.append('<div class="possible-move"></div>');
                    }
                });
            }
            
            // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤
            function clearPossibleMoves() {
                $('#board .possible-move').remove();
                selectedSquare = null;
                possibleMoves = [];
            }
            
            // –ê–Ω–∞–ª–∏–∑ –ø–æ–∑–∏—Ü–∏–∏ —Å Stockfish
            document.getElementById('analyze-btn').addEventListener('click', function() {
                if (game.game_over()) {
                    showResult('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é.', 'error');
                    return;
                }
                
                showResult('–ê–Ω–∞–ª–∏–∑ Stockfish... (10-20 —Å–µ–∫—É–Ω–¥)', 'info');
                
                try {
                    const stockfish = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
                    
                    let evaluation = "0.0";
                    let bestMove = null;
                    let isAnalysisComplete = false;
                    
                    const analysisTimer = setTimeout(() => {
                        if (!isAnalysisComplete) {
                            showResult('–ê–Ω–∞–ª–∏–∑ –∑–∞–Ω—è–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.', 'warning');
                            stockfish.terminate();
                        }
                    }, 30000);
                    
                    stockfish.onmessage = function(event) {
                        const data = event.data;
                        
                        // –ü–∞—Ä—Å–∏–º –æ—Ü–µ–Ω–∫—É –ø–æ–∑–∏—Ü–∏–∏
                        if (data.includes('score cp')) {
                            const match = data.match(/score cp (-?\d+)/);
                            if (match) {
                                const score = parseInt(match[1]) / 100;
                                evaluation = score > 0 ? `+${score.toFixed(1)}` : score.toFixed(1);
                            }
                        }
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ç–∞
                        else if (data.includes('score mate')) {
                            const match = data.match(/score mate (-?\d+)/);
                            if (match) {
                                const moves = Math.abs(parseInt(match[1]));
                                evaluation = match[1] > 0 
                                    ? `–ú–∞—Ç –±–µ–ª—ã–º –≤ ${moves} —Ö–æ–¥–æ–≤` 
                                    : `–ú–∞—Ç —á—ë—Ä–Ω—ã–º –≤ ${moves} —Ö–æ–¥–æ–≤`;
                            }
                        }
                        // –õ—É—á—à–∏–π —Ö–æ–¥
                        else if (data.startsWith('bestmove')) {
                            isAnalysisComplete = true;
                            clearTimeout(analysisTimer);
                            
                            bestMove = data.split(' ')[1];
                            
                            if (bestMove && bestMove !== '(none)') {
                                showResult(`
                                    <p><strong>–õ—É—á—à–∏–π —Ö–æ–¥:</strong> ${bestMove}</p>
                                    <p><strong>–û—Ü–µ–Ω–∫–∞ –ø–æ–∑–∏—Ü–∏–∏:</strong> ${evaluation}</p>
                                    <button id="apply-move-btn" class="apply-btn">–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ—Ç —Ö–æ–¥</button>
                                `);
                                
                                document.getElementById('apply-move-btn').addEventListener('click', () => {
                                    game.move({
                                        from: bestMove.substring(0, 2),
                                        to: bestMove.substring(2, 4),
                                        promotion: 'q'
                                    });
                                    board.position(game.fen());
                                    updateStatus();
                                });
                            } else {
                                showResult('–õ—É—á—à–∏–π —Ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
                            }
                            
                            stockfish.terminate();
                        }
                    };
                    
                    // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥ –¥–ª—è Stockfish
                    stockfish.postMessage('uci');
                    stockfish.postMessage('isready');
                    stockfish.postMessage(`position fen ${game.fen()}`);
                    stockfish.postMessage('go depth 14');
                    
                } catch (error) {
                    showResult(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
                    console.error('Stockfish error:', error);
                }
            });
            
            // –°–±—Ä–æ—Å –¥–æ—Å–∫–∏
            document.getElementById('reset-btn').addEventListener('click', function() {
                game.reset();
                board.position('start');
                clearPossibleMoves();
                document.getElementById('result').innerHTML = '';
            });
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
            document.getElementById('theme-btn').addEventListener('click', function() {
                document.body.classList.toggle('dark');
                this.textContent = document.body.classList.contains('dark') 
                    ? '‚òÄÔ∏è –í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É' 
                    : 'üåô –í–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—É—é —Ç–µ–º—É';
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä—ã
            function updateStatus() {
                if (game.in_checkmate()) {
                    showResult('–®–∞—Ö –∏ –º–∞—Ç!', 'checkmate');
                } else if (game.in_draw()) {
                    showResult('–ù–∏—á—å—è!', 'draw');
                } else if (game.in_check()) {
                    showResult('–®–∞—Ö!', 'check');
                } else {
                    document.getElementById('result').innerHTML = '';
                }
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞
            function showResult(message, type = 'info') {
                const resultDiv = document.getElementById('result');
                
                switch(type) {
                    case 'error':
                        resultDiv.innerHTML = `<p class="error">${message}</p>`;
                        break;
                    case 'warning':
                        resultDiv.innerHTML = `<p class="warning">${message}</p>`;
                        break;
                    case 'checkmate':
                        resultDiv.innerHTML = `<p class="checkmate">${message}</p>`;
                        break;
                    case 'draw':
                        resultDiv.innerHTML = `<p class="draw">${message}</p>`;
                        break;
                    case 'check':
                        resultDiv.innerHTML = `<p class="check">${message}</p>`;
                        break;
                    case 'info':
                        resultDiv.innerHTML = `<p>${message}</p>`;
                        break;
                    default:
                        resultDiv.innerHTML = message;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark');
                document.getElementById('theme-btn').textContent = '‚òÄÔ∏è –í–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É';
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å–∫–∏
            initBoard();
        });
    </script>
</body>
</html>
